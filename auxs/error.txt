# Flujo de Depuración para el Módulo de Presupuestos

Este flujo te guiará paso a paso para reproducir el problema de la actualización del `monto_gastado` en una `PartidaPresupuestaria` y nos permitirá observar los logs de depuración.

**PRE-REQUISITO IMPORTANTE:**
Asegúrate de que tu servidor backend esté **reiniciado** con los logs de depuración que añadí en `backend/api/views.py`.
Comando para reiniciar: `backend/venv/Scripts/python.exe backend/manage.py runserver`

---

**PASO 1: Crear un Departamento (si no tienes uno)**

Necesitamos un departamento para la partida presupuestaria.
*   **Método:** POST
*   **URL:** `/api/departamentos/`
*   **Body (JSON):**
    ```json
    {
        "nombre": "Departamento de TI"
    }
    ```
*   **Acción:** Ejecuta esta solicitud. Si ya tienes un departamento, anota su `id`. Si lo creas, anota el `id` del departamento creado.

---

**PASO 2: Crear un Período Presupuestario**

*   **Método:** POST
*   **URL:** `/api/periodos-presupuestarios/`
*   **Body (JSON):**
    ```json
    {
        "nombre": "Presupuesto Anual 2025",
        "fecha_inicio": "2025-01-01",
        "fecha_fin": "2025-12-31",
        "estado": "ACTIVO"
    }
    ```
*   **Acción:** Ejecuta esta solicitud. Anota el `id` del `PeriodoPresupuestario` creado.

---

**PASO 3: Crear una Partida Presupuestaria**

Vamos a crear una partida para "Muebles de Oficina".
*   **Método:** POST
*   **URL:** `/api/partidas-presupuestarias/`
*   **Body (JSON):**
    ```json
    {
        "periodo_id": "ID_DEL_PERIODO_CREADO_EN_PASO_2",
        "departamento_id": "ID_DEL_DEPARTAMENTO_CREADO_EN_PASO_1",
        "nombre": "Muebles de Oficina",
        "codigo": "MUEB-001",
        "monto_asignado": "3500.00"
    }
    ```
*   **Acción:** Ejecuta esta solicitud. **Asegúrate de reemplazar `ID_DEL_PERIODO_CREADO_EN_PASO_2` y `ID_DEL_DEPARTAMENTO_CREADO_EN_PASO_1` con los IDs reales.** Anota el `id` de la `PartidaPresupuestaria` creada.

---

**PASO 4: Verificar la Partida Presupuestaria (Inicial)**

Antes de la compra, verifica el estado inicial de la partida.
*   **Método:** GET
*   **URL:** `/api/partidas-presupuestarias/ID_DE_LA_PARTIDA_CREADA_EN_PASO_3/`
*   **Acción:** Ejecuta esta solicitud. **Asegúrate de reemplazar `ID_DE_LA_PARTIDA_CREADA_EN_PASO_3` con el ID real.**
    *   **Esperado:** `monto_gastado` debe ser "0.00", `monto_disponible` debe ser "3500.00".
*   **Por favor, copia y pega la respuesta JSON de esta solicitud aquí.**

---

**PASO 5: Crear una Solicitud de Compra**

Solicitamos una "Mesa de Oficina" por 500.
*   **Método:** POST
*   **URL:** `/api/solicitudes-compra/`
*   **Body (JSON):**
    ```json
    {
        "descripcion": "Mesa de Oficina para Gerencia",
        "costo_estimado": "500.00",
        "departamento_id": "ID_DEL_DEPARTAMENTO_CREADO_EN_PASO_1",
        "partida_presupuestaria_id": "ID_DE_LA_PARTIDA_CREADA_EN_PASO_3"
    }
    ```
*   **Acción:** Ejecuta esta solicitud. **Asegúrate de reemplazar los IDs.** Anota el `id` de la `SolicitudCompra` creada.

---

**PASO 6: Aprobar la Solicitud de Compra**

*   **Método:** POST
*   **URL:** `/api/solicitudes-compra/ID_DE_LA_SOLICITUD_CREADA_EN_PASO_5/decidir/`
*   **Body (JSON):**
    ```json
    {
        "decision": "aprobar"
    }
    ```
*   **Acción:** Ejecuta esta solicitud. **Asegúrate de reemplazar `ID_DE_LA_SOLICITUD_CREADA_EN_PASO_5` con el ID real.**

---

**PASO 7: Crear una Orden de Compra**

*   **Método:** POST
*   **URL:** `/api/ordenes-compra/`
*   **Body (JSON):**
    ```json
    {
        "solicitud_id": "ID_DE_LA_SOLICITUD_CREADA_EN_PASO_5",
        "proveedor_id": "ID_DE_UN_PROVEEDOR_EXISTENTE_O_CREA_UNO",
        "precio_final": "500.00",
        "fecha_entrega_estimada": "2025-12-15"
    }
    ```
*   **Acción:** Ejecuta esta solicitud. **Asegúrate de reemplazar los IDs.**
    *   **Nota:** Si no tienes un proveedor, crea uno primero (`/api/proveedores/` con `{"nombre": "Mueblerias S.A.", "contacto": "info@mueblerias.com"}`). Anota el `id` de la `OrdenCompra` creada.

---

**PASO 8: Ejecutar la Acción `recibir` en la Orden de Compra**

Aquí es donde esperamos que se actualice el `monto_gastado`.
*   **Método:** POST
*   **URL:** `/api/ordenes-compra/ID_DE_LA_ORDEN_CREADA_EN_PASO_7/recibir/`
*   **Body (JSON):**
    ```json
    {
        "categoria_id": "ID_DE_UNA_CATEGORIA_EXISTENTE_O_CREA_UNA",
        "estado_id": "ID_DE_UN_ESTADO_EXISTENTE_O_CREA_UNO",
        "ubicacion_id": "ID_DE_UNA_UBICACION_EXISTENTE_O_CREA_UNA",
        "vida_util": 5
    }
    ```
*   **Acción:** Ejecuta esta solicitud. **Asegúrate de reemplazar los IDs.**
    *   **Nota:** Si no tienes Categoría, Estado o Ubicación, crea uno primero.
        *   Categoría: `/api/categorias-activo/` con `{"nombre": "Muebles"}`
        *   Estado: `/api/estados/` con `{"nombre": "Nuevo"}`
        *   Ubicación: `/api/ubicaciones/` con `{"nombre": "Oficina Principal"}`
*   **¡IMPORTANTE! Después de ejecutar esta solicitud, copia y pega TODO el output de la consola de tu servidor backend aquí.**

---

**PASO 9: Verificar la Partida Presupuestaria (Final)**

Verifica el estado final de la partida después de la compra.
*   **Método:** GET
*   **URL:** `/api/partidas-presupuestarias/ID_DE_LA_PARTIDA_CREADA_EN_PASO_3/`
*   **Acción:** Ejecuta esta solicitud. **Asegúrate de reemplazar `ID_DE_LA_PARTIDA_CREADA_EN_PASO_3` con el ID real.**
    *   **Esperado:** `monto_gastado` debe ser "500.00", `monto_disponible` debe ser "3000.00".
*   **Por favor, copia y pega la respuesta JSON de esta solicitud aquí.**

---
**FIN DEL FLUJO DE DEPURACIÓN**
---
